<?xml version="1.0" encoding="utf-8"?>
<s:TitleWindow xmlns:fx="http://ns.adobe.com/mxml/2009" 
			   xmlns:s="library://ns.adobe.com/flex/spark" 
			   xmlns:mx="library://ns.adobe.com/flex/mx" width="392" height="176" title="Downloading File" xmlns:view="wonderland.view.*"
			   close="PopUpManager.removePopUp(this);">

	<fx:Script>
		<![CDATA[
			import mx.controls.Alert;
			import mx.managers.PopUpManager;
			import mx.rpc.events.FaultEvent;
			
			import wonderland.documents.controller.DocumentDataControllerClient;
			
			public var serverURL:String;
			public var documentVersionID:Number;
			public var fileName:String;
			
			private var fileData:* ;
			
			
			public function download():void
			{
				var cnt:DocumentDataControllerClient = new DocumentDataControllerClient(serverURL);
				cnt.getDocumentData(documentVersionID,documentDataResult,fault);
			}
			
			private function documentDataResult(e:Event):void{
				gear.doRunRun = false;
				
				
				var loader:URLLoader = e.target as URLLoader;
				if(loader.bytesLoaded>0){
					message.text = "The file is ready to be saved";
					fileData = loader.data;
					saveBTN.enabled = true;
				}
			}
			
			private function fault(e:FaultEvent):void{
				gear.doRunRun = false;
				Alert.show(e.fault.message,"Server Error");
			}
			
			
			
			protected function save(event:MouseEvent):void
			{
				var fr:FileReference = new FileReference();
				fr.save(fileData,fileName);
				
			}
		]]>
	</fx:Script>

	<fx:Declarations>
		<!-- Place non-visual elements (e.g., services, value objects) here -->
	</fx:Declarations>
	<view:Gear id="gear" x="7" y="61" width="100" height="100" alpha="0.6" hasShadow="true" doRunRun="true" speed="0.4"/>
	<s:Label id="message" x="0" y="17" text="Your file is beeing fetched from the server" width="100%" verticalAlign="top" fontSize="15" textAlign="center"/>
	<mx:Button id="saveBTN" x="324" y="77" icon="@Embed(source='../../../assets/images/png/save 2_48x48.png')" width="56" height="56" enabled="false"
			   click="save(event)"/>
	<s:Label x="10" y="103" text="Downloading" width="97" textAlign="center" visible="{!saveBTN.enabled}"/>
</s:TitleWindow>
